<!DOCTYPE html>
	<html>
	<nav>
		<a href="/">Home</a>
		<a href="./utilityfinder">Utility Finder</a>
		<a>Interactive Map</a>
	</nav>
	<head>
		<script src='https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.js'></script>
		<link href='https://api.mapbox.com/mapbox-gl-js/v1.10.1/mapbox-gl.css' rel='stylesheet'/>
		<script src="/node_modules/dygraphs/dist/dygraph.js"></script>
      	<link rel="stylesheet" href="/node_modules/dygraphs/dist/dygraph.css"/>
		<title>Data+ Utility Finder Homepage</title>

	</head>
	<body>
	<h1>Result</h1>
	<p>Address is: {{ad}}, Zipcode is: {{zipc}}, State is: {{st}}</p>
	<br><br>
	<p>Latitude is: {{lat}}, Longitude is {{lon}} </p>
	<br><br>
	<p>Utility is: {{uname}}, Conservation plan information: <a href={{linkname}} target="_blank">{{linkname}}</a> </p>
	<p id='titlePara'>{{ gtt }}</p>
	<input type="text" id="titlename" name="titlename" value={{ gtt }}/>
	<input type="button" value="alertTitle" onclick="gettitle()"/>  
	<div>
		<div id='map' style='float: left; width: 800px; height: 500px;'></div>
		<div id="graphdiv" style="float: right; width:600px; height:500px;"></div>
	</div>
	<script type="text/javascript">


		var getJSON = function(url, callback) {
		    var xhr = new XMLHttpRequest();
		    xhr.open('GET', url, true);
		    xhr.responseType = 'json';
		    xhr.onload = function() {
		      var status = xhr.status;
		      if (status === 200) {
		        callback(null, xhr.response);
		      } else {
		        callback(status, xhr.response);
		      }
		    };
		    xhr.send();
		};

		// is this the right place for this? 
	
	function gettitle(){  
	var graphTitleName = document.getElementById('titlePara'); 
	alert("Graph Title: "+(typeof graphTitleName)); 
	} 
	var data = 'date,precipitation\n2018-01-01,83.84160786786978\n2018-01-02,80.05760053668881\n2018-01-03,78.98465325977341\n2018-01-04,75.63728303392006\n2018-01-05,67.89087588373908\n2018-01-06,67.45936247634494\n2018-01-07,69.17480333972658\n2018-01-08,66.63900508980993\n2018-01-09,62.737921109115966\n2018-01-10,61.797617073998715\n2018-01-11,58.985648172464465\n2018-01-12,61.14607710759779\n2018-01-13,58.62060859161309\n2018-01-14,59.5311134392527\n2018-01-15,59.511019758467256\n2018-01-16,57.66354684118549\n2018-01-17,57.127001592609396\n2018-01-18,57.08341393216471\n2018-01-19,57.14930227560401\n2018-01-20,57.850431903545065\n2018-01-21,58.52918385676559\n2018-01-22,61.79036269310328\n2018-01-23,58.75779688236064\n2018-01-24,60.41876571952363\n2018-01-25,61.534999133932324\n2018-01-26,65.18340813354052\n2018-01-27,64.70457250630389\n2018-01-28,61.22322598042114\n2018-01-29,61.08945983828127\n2018-01-30,61.21363536138997\n2018-01-31,61.257873416522884\n2018-02-01,60.91036796610689\n2018-02-02,59.357445476975485\n2018-02-03,59.75061728014693\n2018-02-04,59.043431882740975\n2018-02-05,59.211616788892975\n2018-02-06,60.43220736040628\n2018-02-07,62.82909774149839\n2018-02-08,66.47674899155399\n2018-02-09,66.00396441649161\n2018-02-10,67.76470614020039\n2018-02-11,69.66723261227006\n2018-02-12,70.03334781947082\n2018-02-13,66.63168595455521\n2018-02-14,69.56805642105553\n2018-02-15,67.28224365355122\n2018-02-16,66.86905092341117\n2018-02-17,68.33552835457172\n2018-02-18,67.23745914921213\n2018-02-19,68.34017744131218\n2018-02-20,64.61475090728658\n2018-02-21,60.85465702061189\n2018-02-22,56.140669456570635\n2018-02-23,54.968755171313894\n2018-02-24,53.56664685226711\n2018-02-25,50.15271020196771\n2018-02-26,50.55100498761731\n2018-02-27,50.39208501212895\n2018-02-28,52.531345821845676\n2018-03-01,53.742301135718535\n2018-03-02,51.559183726007674\n2018-03-03,52.17513349944026\n2018-03-04,53.235846597407104\n2018-03-05,51.33276482194889\n2018-03-06,49.494713402168244\n2018-03-07,45.004800066296994\n2018-03-08,43.3457293686051\n2018-03-09,40.850026063159156\n2018-03-10,43.538854344624596\n2018-03-11,42.25415541660017\n2018-03-12,43.714983322078474\n2018-03-13,42.31574743663616\n2018-03-14,44.737367687530735\n2018-03-15,45.291683626441504\n2018-03-16,44.287569180041615\n2018-03-17,43.24110746399863\n2018-03-18,42.48499140848981\n2018-03-19,45.739602043837884\n2018-03-20,41.54695175977496\n2018-03-21,41.700707753263785\n2018-03-22,41.85769448694477\n2018-03-23,38.852969235390354\n2018-03-24,39.415004449871226\n2018-03-25,44.43451998959833\n2018-03-26,47.44323011988557\n2018-03-27,47.616998548633354\n2018-03-28,48.8899797804237\n2018-03-29,47.4044174599151\n2018-03-30,50.80556573400617\n2018-03-31,50.0615441555714\n2018-04-01,53.09919638729848\n2018-04-02,51.553977426591864\n2018-04-03,52.92508959899464\n2018-04-04,54.91065819932013\n2018-04-05,55.382681033235855\n2018-04-06,56.66297659487515\n2018-04-07,57.438125319431535\n2018-04-08,54.160946256698864\n2018-04-09,56.1865526899426\n2018-04-10,60.11736367040597\n2018-04-11,64.51075738319835\n2018-04-12,67.56698384668252\n2018-04-13,70.2554796750736\n2018-04-14,71.64690218749034\n2018-04-15,72.37123108328444\n2018-04-16,72.24491665157801\n2018-04-17,71.52350228486405\n2018-04-18,71.3057217761584\n2018-04-19,70.88172667459699\n2018-04-20,74.058015241514\n2018-04-21,74.80564500562096\n2018-04-22,71.23144257068027\n2018-04-23,69.52806080609079\n2018-04-24,67.55541421686219\n2018-04-25,66.90916606207317\n2018-04-26,64.91562569947499\n2018-04-27,61.870359510389434\n2018-04-28,60.047404448263094\n2018-04-29,61.8276844319773\n2018-04-30,65.29069849127072\n2018-05-01,65.79857867561245\n2018-05-02,65.2510544560979\n2018-05-03,64.56511525188479\n2018-05-04,62.96709870098732\n2018-05-05,65.56648055884847\n2018-05-06,66.36901617460762\n2018-05-07,69.46811214581403\n2018-05-08,66.73261101634887\n2018-05-09,63.649192687530366\n2018-05-10,63.61403265732161\n2018-05-11,69.09730828296853\n2018-05-12,66.32146002320475\n2018-05-13,67.22019368776213\n2018-05-14,68.19031946508213\n2018-05-15,67.54230094600706\n2018-05-16,69.43033986795379\n2018-05-17,70.59209842550106\n2018-05-18,65.02735174809015\n2018-05-19,65.28144817634339\n2018-05-20,67.69668409561658\n2018-05-21,69.70900320951306\n2018-05-22,72.30862663097544\n2018-05-23,71.72878183688611\n2018-05-24,71.86396731140033\n2018-05-25,70.54960081214949\n2018-05-26,68.53995709520933\n2018-05-27,67.79817458950428\n2018-05-28,66.87346511091606\n2018-05-29,65.56335067983656\n2018-05-30,64.30209166030492\n2018-05-31,63.39681840551125\n2018-06-01,64.29763432621829\n2018-06-02,65.64029963605824\n2018-06-03,68.36615794438275\n2018-06-04,71.77215382966024\n2018-06-05,74.06090986197111\n2018-06-06,75.02681536709825\n2018-06-07,74.2313344671598\n2018-06-08,76.89657343773428\n2018-06-09,73.4767767442248\n2018-06-10,70.82753462522824\n2018-06-11,70.03231642443606\n2018-06-12,70.53292780268755\n2018-06-13,72.96049857126668\n2018-06-14,71.98902505778702\n2018-06-15,68.92021789622444\n2018-06-16,71.72427864379716\n2018-06-17,72.12582106180164\n2018-06-18,71.32389625656943\n2018-06-19,70.74936023636839\n2018-06-20,69.14661657814514\n2018-06-21,66.62349982895832\n2018-06-22,67.01280760707854\n2018-06-23,64.59279763047675\n2018-06-24,67.4021592247034\n2018-06-25,68.862178996229\n2018-06-26,67.04467186835805\n2018-06-27,68.21682989002251\n2018-06-28,70.32417245841222\n2018-06-29,69.26629526349669\n2018-06-30,69.59473174651774\n2018-07-01,66.85388401284611\n2018-07-02,68.67762943666986\n2018-07-03,65.87707380218419\n2018-07-04,66.65084781469369\n2018-07-05,67.201849436513\n2018-07-06,67.57852005359112\n2018-07-07,67.60060379634935\n2018-07-08,69.28792507259365\n2018-07-09,67.43246827174613\n2018-07-10,71.35978596501121\n2018-07-11,70.43400217350991\n2018-07-12,68.4624687973742\n2018-07-13,64.83357314871319\n2018-07-14,63.28336456444679\n2018-07-15,66.15572214669594\n2018-07-16,68.53752505138925\n2018-07-17,67.18676279838829\n2018-07-18,64.19729477274657\n2018-07-19,63.33833376466031\n2018-07-20,64.10720703515564\n2018-07-21,67.24732750243848\n2018-07-22,71.1588818832308\n2018-07-23,67.76628851386461\n2018-07-24,65.66902005482581\n2018-07-25,65.07596157461272\n2018-07-26,63.89496462127482\n2018-07-27,62.20401265122582\n2018-07-28,59.2401065725286\n2018-07-29,57.89477755930807\n2018-07-30,55.92690634717356\n2018-07-31,56.72517171416485\n2018-08-01,58.869796662108776\n2018-08-02,57.22481036666359\n2018-08-03,58.09669880129919\n2018-08-04,57.276347293741615\n2018-08-05,56.677231427219326\n2018-08-06,54.61177862333982\n2018-08-07,53.14672367479999\n2018-08-08,58.46540779130879\n2018-08-09,59.35156120361707\n2018-08-10,61.35159327090484\n2018-08-11,60.70444664266512\n2018-08-12,60.183096878227616\n2018-08-13,58.50470593889406\n2018-08-14,60.64446509768688\n2018-08-15,60.8733465150106\n2018-08-16,59.79756820005199\n2018-08-17,58.203114566283986\n2018-08-18,56.3904183140407\n2018-08-19,51.2868225834593\n2018-08-20,51.67638681559689\n2018-08-21,60.307219190433464\n2018-08-22,61.08137890440185\n2018-08-23,59.447011486864746\n2018-08-24,58.21682501708536\n2018-08-25,57.38162774733403\n2018-08-26,57.38409764636322\n2018-08-27,56.5356616525735\n2018-08-28,54.99196491909704\n2018-08-29,55.84795810328006\n2018-08-30,54.21916656791301\n2018-08-31,56.44305016083849\n2018-09-01,58.06396094507425\n2018-09-02,57.3582467516971\n2018-09-03,58.80688646298191\n2018-09-04,58.691039147771214\n2018-09-05,59.84055721601485\n2018-09-06,62.18284270743416\n2018-09-07,63.91168084999631\n2018-09-08,63.564701788026504\n2018-09-09,62.572706175279244\n2018-09-10,62.7295000223935\n2018-09-11,65.40317721433931\n2018-09-12,62.498450292412144\n2018-09-13,59.32370862443546\n2018-09-14,61.451673429778545\n2018-09-15,61.36137786435058\n2018-09-16,60.910037957586354\n2018-09-17,56.428675259311724\n2018-09-18,54.967731367405854\n2018-09-19,54.15020245010803\n2018-09-20,53.30290657717548\n2018-09-21,53.04872202910136\n2018-09-22,48.619581234192246\n2018-09-23,47.39072221115476\n2018-09-24,47.00249139809869\n2018-09-25,49.26345096250704\n2018-09-26,53.84601057569515\n2018-09-27,56.00233074653867\n2018-09-28,56.22595050936509\n2018-09-29,56.48197501006925\n2018-09-30,58.556324715096686\n2018-10-01,59.33414600299362\n2018-10-02,55.460655832442725\n2018-10-03,55.518934651923686\n2018-10-04,57.70758580247529\n2018-10-05,58.18741125681837\n2018-10-06,59.6934352783094\n2018-10-07,59.251868261233426\n2018-10-08,62.09214618009842\n2018-10-09,58.656544011430206\n2018-10-10,60.43506757632493\n2018-10-11,60.91669904987496\n2018-10-12,60.87551948434721\n2018-10-13,62.62287417397486\n2018-10-14,62.924858056229965\n2018-10-15,58.06449047270733\n2018-10-16,61.62157004952882\n2018-10-17,64.826417481508\n2018-10-18,62.57460299316195\n2018-10-19,61.797049323679644\n2018-10-20,62.96156627078115\n2018-10-21,66.48387674072579\n2018-10-22,65.91821263149275\n2018-10-23,67.58108069312266\n2018-10-24,66.66318789746265\n2018-10-25,71.30694034798924\n2018-10-26,70.61027458009846\n2018-10-27,70.1090855961651\n2018-10-28,69.73846163025819\n2018-10-29,72.45309581400112\n2018-10-30,71.91070538182053\n2018-10-31,75.62955019637035\n2018-11-01,73.13717021996169\n2018-11-02,72.76696564689209\n2018-11-03,73.86803440226049\n2018-11-04,74.1625162058746\n2018-11-05,75.37755021752808\n2018-11-06,76.00266347607106\n2018-11-07,76.50459700469996\n2018-11-08,76.69465470432291\n2018-11-09,76.20815772230479\n2018-11-10,77.80602061682075\n2018-11-11,78.73529710476042\n2018-11-12,77.5100911847757\n2018-11-13,79.02521044694105\n2018-11-14,81.36472401761517\n2018-11-15,80.74886454908996\n2018-11-16,78.01101349652862\n2018-11-17,78.77996070923048\n2018-11-18,78.24763200296647\n2018-11-19,78.14866376123814\n2018-11-20,78.23693401641174\n2018-11-21,75.9218380109522\n2018-11-22,79.1449984788987\n2018-11-23,80.24500390070267\n2018-11-24,81.13676829572331\n2018-11-25,79.20336704412915\n2018-11-26,81.75938311799982\n2018-11-27,84.1633897152885\n2018-11-28,83.0579205233257\n2018-11-29,83.86192910529121\n2018-11-30,87.19356239436081\n2018-12-01,85.68042795432406\n2018-12-02,81.83931681931566\n2018-12-03,81.48783355213561\n2018-12-04,77.59094883907153\n2018-12-05,74.90041749001415\n2018-12-06,81.71577839746304\n2018-12-07,80.30758264662339\n2018-12-08,80.04023789951044\n2018-12-09,78.67328862182072\n2018-12-10,75.84365828162808\n2018-12-11,77.03900627003091\n2018-12-12,74.81072203377511\n2018-12-13,73.77506739733711\n2018-12-14,72.90836460186027\n2018-12-15,74.81058775552661\n2018-12-16,71.6469596706116\n2018-12-17,68.33858188174187\n2018-12-18,70.0180849418022\n2018-12-19,71.40771636113625\n2018-12-20,70.34278706349627\n2018-12-21,69.73693305309689\n2018-12-22,71.05506349437155\n2018-12-23,66.53593759464832\n2018-12-24,64.47516653363486\n2018-12-25,66.06707059753789\n2018-12-26,65.55444767373119\n2018-12-27,67.81395141997012\n2018-12-28,70.40414406756204\n2018-12-29,71.25919591854708\n2018-12-30,73.03043502137201\n2018-12-31,71.28493548585662\n2019-01-01,73.53905366715313\n';
	g = new Dygraph(

      // containing div
      document.getElementById("graphdiv"),

      // CSV or path to a CSV file.
      data,
      {
        ylabel: 'Amount (units)',
        title: document.getElementById('titlename').value, //'Calculation of Amount of Units from Streamgage',
        legend: 'always'
      }
		  );

		mapboxgl.accessToken = 'pk.eyJ1IjoiYnR3MTkiLCJhIjoiY2tiOGR6MzI1MDNjaTJ0c3hnZHBmODRneSJ9.QVj1xKQ--FUvtw6soygk9g';
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/btw19/ckb9tgy821c6j1itda2ynmftu', // stylesheet location
			center: [-79, 35.99], // starting position [lng, lat]
			zoom: 6 // starting zoom
		});

		map.on('load', function() {
			//Add a source for the state polygons.
			map.addSource('utilities', {
				'type': 'vector',
				'data': 'mapbox://btw19.2fhcidlx'
			});
      
      map.addSource('utilitiesicons', {
'type': 'geojson',
'data': {
'type': 'FeatureCollection',
'features': [
{
'type': 'Feature',
'properties': {
'description': '<a href="https://google.com">One</a>',
'siteNumber': '02043433',
'iconSize': [60, 60]
},
'geometry': {
'type': 'Point',
'coordinates': [-77.2, 35.3]
}
},
{
'type': 'Feature',
'properties': {
'description': '<a href="https://google.com">Two</a>',
'siteNumber': '02053200',
'iconSize': [50, 50]
},
'geometry': {
'type': 'Point',
'coordinates': [-79.1, 35.99]
}
},
{
'type': 'Feature',
'properties': {
'description': '<a href="https://google.com">Three</a>',
'siteNumber': '02069000',
'iconSize': [40, 40]
},
'geometry': {
'type': 'Point',
'coordinates': [-80, 34.9]
}
}
]
}
});
	 map.addLayer({
            'id': 'utilitiesicons',
            'type': 'symbol',
            'source': 'utilitiesicons',
            'layout': {
                'icon-image': 'rocket-15',
                'icon-allow-overlap': true
            }
        });
			// Add a layer showing the state polygons.
			map.addLayer({
				'id': 'utilities-layer',
				'type': 'fill',
				'source': 'utilities',
				'paint': {
					'fill-color': 'rgba(200, 100, 240, 0.4)',
					'fill-outline-color': 'rgba(200, 100, 240, 1)'
				}
			});
	 
			// When a click event occurs on a feature in the states layer, open a popup at the
			// location of the click, with description HTML from its properties.
			map.on('click', 'utilities-layer', function(e) {
				new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(e.features[0].properties.name)
					.addTo(map);
			});
	 
			// Change the cursor to a pointer when the mouse is over the states layer.
			map.on('mouseenter', 'utilities-layer', function() {
				map.getCanvas().style.cursor = 'pointer';
			});
	 
			// Change it back to a pointer when it leaves.
			map.on('mouseleave', 'utilities-layer', function() {
				map.getCanvas().style.cursor = '';
			});
      map.on('click', 'utilitiesicons', function(e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;
            var siteNumber = e.features[0].properties.siteNumber;

			getJSON(`/nwis_data/${siteNumber}`, function(err, data) {
			new_data = [];
			console.log("stuff")
			for (i=0; i<data.data.length; i++) {
				data.data[i][0] = new Date(data.data[i][0]);
				console.log("foo"); 
			}
			console.log(data); 	
			g.updateOptions({'file': data.data})})//console.log(result.rows[0]['signal'])});            

   //          client.connect();
			// client
			//   .query("SELECT signal FROM nwis.daily WHERE nwis_site_no = $1", [site_no])
			//   .then(result => {data = initialFunction(result.rows); g.updateOptions({'file': data})})//console.log(result.rows[0]['signal']))
			//   .catch(e => console.error(e.stack))
			//   .then(() => client.end())

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
        });

        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'utilitiesicons', function() {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'utilitiesicons', function() {
            map.getCanvas().style.cursor = '';
        });
	});


	</script>
	</body>
	</html>